<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Meseta</title>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://unpkg.com/@zxing/library@0.20.0"></script>
<style>
:root{
  --bg:#000;--panel:#0a0a0a;--card:#0f0f0f;--ink:#fff;--muted:#bfbfbf;--line:rgba(255,255,255,.15);
  --radius:18px;--t:160ms cubic-bezier(.2,.6,.2,1);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;color:var(--ink);font-family:"Poppins",system-ui,Segoe UI,Roboto,sans-serif;background:
  radial-gradient(1100px 520px at 120% -20%,rgba(255,255,255,.06),transparent 60%),
  radial-gradient(900px 420px at -20% 120%,rgba(255,255,255,.05),transparent 60%),#000}

/* Top */
.top{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,rgba(0,0,0,.95),rgba(0,0,0,.78));border-bottom:1px solid var(--line);backdrop-filter:blur(6px)}
.wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
.brand{display:flex;align-items:center;gap:12px}
.brand .script{font-family:"Great Vibes",cursive;font-size:36px}
.disco{font-size:26px;cursor:pointer;user-select:none}

.center-cta{position:relative;flex:1;display:flex;justify-content:center;align-items:center}
.center-cta .title{
  /* sin borde ni relleno: solo texto */
  font-weight:900;letter-spacing:.3px;color:#fff;text-shadow:0 2px 18px rgba(255,255,255,.35);
}
.center-cta::before,.center-cta::after{
  content:"";position:absolute;top:50%;width:36%;height:2px;border-radius:2px;filter:blur(.4px);
  background:linear-gradient(90deg,rgba(255,255,255,0),rgba(255,255,255,.85),rgba(255,255,255,0));
}
.center-cta::before{left:0;transform:translateY(-50%)}
.center-cta::after{right:0;transform:translateY(-50%)}

/* user area */
.userzone{margin-left:auto;display:flex;gap:10px;align-items:center}
.userchip{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0d0d0d;cursor:pointer}
.loginbtn{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#111;font-weight:700;cursor:pointer}

/* Men√∫ lateral (bola disco) */
.side{position:fixed;left:16px;top:62px;width:240px;background:#0c0c0c;border:1px solid var(--line);border-radius:14px;box-shadow:0 16px 40px rgba(0,0,0,.6);display:none}
.side.show{display:block}
.side .item{padding:12px 14px;border-bottom:1px solid var(--line);cursor:pointer}
.side .item:last-child{border-bottom:0}
.side .item:hover{background:#121212}

/* Secciones */
.main{padding:20px 16px}
.section{display:none;opacity:0;transform:translateY(6px);transition:opacity var(--t),transform var(--t)}
.section.show{display:block;opacity:1;transform:none}

/* Card */
.card{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:0 14px 38px rgba(0,0,0,.55)}
.card-h{display:flex;justify-content:space-between;align-items:center;padding:16px;border-bottom:1px solid var(--line)}
.card-c{padding:16px}
.badge{display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid var(--line);background:#0d0d0d;color:#e2e2e2;font-size:.9rem}

/* Form */
.field{display:grid;gap:6px;min-width:0}
label{color:var(--muted)}
input,select,textarea{width:100%;padding:12px;border-radius:14px;background:#0b0b0b;border:1px solid var(--line);color:var(--ink)}
input:focus,select:focus,textarea:focus{outline:none;border-color:#fff;box-shadow:0 0 0 3px rgba(255,255,255,.15)}
.grid{display:grid;gap:16px}
.two{grid-template-columns:1fr 1fr}
.three{grid-template-columns:repeat(3,1fr)}
@media(max-width:1000px){.two,.three{grid-template-columns:1fr}}
.btn{border-radius:14px;padding:10px 14px;background:#0d0d0d;border:1px solid var(--line);font-weight:800;cursor:pointer}
.btn.primary{background:#fff;color:#000}
.btn.ok{background:linear-gradient(180deg,rgba(34,197,94,.28),rgba(34,197,94,.4));border:1px solid rgba(34,197,94,.55)}
.hidden{display:none!important}

/* M√©todos de pago */
.methods{display:grid;grid-template-columns:repeat(3,minmax(240px,1fr));gap:14px}
.method{display:flex;gap:12px;padding:16px;border:1px solid var(--line);background:#0d0d0d;border-radius:16px;cursor:pointer}
.method:hover{outline:2px solid rgba(255,255,255,.25);outline-offset:2px}
.m-ico{width:64px;height:40px;border-radius:10px;border:1px solid var(--line);display:grid;place-items:center;background:#111;overflow:hidden}
.m-title{font-weight:900}
.m-sub{color:var(--muted);font-size:.9rem}
.panel{margin-top:12px;border:1px dashed var(--line);border-radius:12px;padding:12px;display:none}
.panel.show{display:block}

/* Wallet logo */
.wallet{width:36px;height:28px;border-radius:6px;background:#fff;position:relative}
.wallet::before{content:"";position:absolute;left:2px;right:2px;top:6px;height:16px;border-radius:4px;background:linear-gradient(180deg,#3b82f6,#60a5fa)}

/* Editor / QR */
.qrbox{display:grid;place-items:center;padding:12px;border-radius:16px;background:#0d0d0d;border:1px dashed rgba(255,255,255,.35)}
video{width:100%;max-height:360px;border-radius:16px;border:1px solid var(--line);background:#000}

/* Toast */
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0d0d0d;color:#fff;border:1px solid var(--line);padding:12px 14px;border-radius:12px;z-index:120}

/* Modal simple */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px;z-index:120}
.modal.show{display:flex}
.modal-body{background:#0f0f0f;border:1px solid var(--line);border-radius:16px;max-width:520px;width:100%}
.modal-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
.modal-c{padding:14px}
</style>
</head>
<body>

<header class="top">
  <div class="wrap row">
    <div class="brand row">
      <div id="discoBtn" class="disco" title="Men√∫">ü™©</div>
      <div class="script">Meseta</div>
    </div>

    <!-- CENTRO: solo texto (sin borde ni fondo) y l√≠neas degradadas -->
    <div class="center-cta"><div class="title" id="headerTitle">Compra tu entrada aqu√≠</div></div>

    <!-- DERECHA: Invitado + Entrar (una sola registraci√≥n de admin) -->
    <div class="userzone">
      <div id="userChip" class="userchip">Invitado</div>
      <button id="loginBtn" class="loginbtn">Entrar</button>
    </div>
  </div>
</header>

<!-- MEN√ö (bola disco) -->
<div id="sideMenu" class="side">
  <div class="item" data-go="shop">Comprar</div>
  <div class="item" data-go="entries">Entradas</div>
  <div class="item" data-go="scan">Escanear</div>
  <div class="item" data-go="event">Crear evento</div>
  <div class="item" data-go="settings">Ajustes</div>
</div>

<main class="main wrap">

  <!-- COMPRAR -->
  <section id="view-shop" class="section show">
    <div class="card">
      <div class="card-h">
        <strong>Comprar entrada (QR de uso √∫nico)</strong>
        <span class="badge" id="shopPrice">Precio: ‚Äî</span>
      </div>
      <div class="card-c">
        <div class="grid two">
          <div class="field">
            <label>Evento</label>
            <select id="shopEvent"></select>
          </div>
          <div class="field">
            <label>Tu nombre y apellido</label>
            <input id="shopName" placeholder="Ej: Ana P√©rez">
          </div>
        </div>

        <div class="methods" style="margin-top:12px">
          <!-- Billetera virtual -->
          <div class="method" id="mWallet">
            <div class="m-ico"><div class="wallet"></div></div>
            <div><div class="m-title">Billetera virtual</div><div class="m-sub">Alias/CBU/CVU + comprobante</div></div>
          </div>
          <div class="method" id="mDebit">
            <div class="m-ico">
              <svg viewBox="0 0 160 100"><defs><linearGradient id="deb" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#f5f5f5"/><stop offset="100%" stop-color="#c9c9c9"/></linearGradient></defs>
              <rect x="6" y="10" rx="12" ry="12" width="148" height="80" fill="url(#deb)"/>
              <rect x="18" y="38" width="124" height="10" rx="5" fill="#9a9a9a"/>
              <rect x="18" y="56" width="82" height="8" rx="4" fill="#b7b7b7"/></svg>
            </div>
            <div><div class="m-title">Tarjeta de d√©bito</div><div class="m-sub">Formulario (usa link bancario)</div></div>
          </div>
          <div class="method" id="mCredit">
            <div class="m-ico">
              <svg viewBox="0 0 160 100"><defs><linearGradient id="cred" x1="0" y1="0" x2="1" y2="1"><stop offset="0%" stop-color="#fff1b8"/><stop offset="100%" stop-color="#d4af37"/></linearGradient></defs>
              <rect x="6" y="10" rx="12" ry="12" width="148" height="80" fill="url(#cred)"/>
              <rect x="18" y="38" width="124" height="10" rx="5" fill="#b8911a"/>
              <rect x="18" y="56" width="72" height="8" rx="4" fill="#caa22a"/></svg>
            </div>
            <div><div class="m-title">Tarjeta de cr√©dito</div><div class="m-sub">Cuotas (usa link bancario)</div></div>
          </div>
        </div>

        <!-- Paneles -->
        <div id="pWallet" class="panel">
          <div class="grid two">
            <div class="field"><label>Alias / CBU / CVU (del evento)</label><input id="walletAlias" readonly></div>
            <div class="field"><label>Titular</label><input id="walletHolder" readonly></div>
          </div>
          <div class="grid two" style="margin-top:8px">
            <div class="field"><label>Sub√≠ comprobante (imagen)</label><input id="walletProof" type="file" accept="image/*"></div>
            <div class="field" style="align-self:end"><button class="btn ok" id="walletConfirm">Confirmar pago</button></div>
          </div>
        </div>

        <div id="pDebit" class="panel">
          <div class="grid two">
            <div class="field"><label>Tarjeta (simulado)</label><input placeholder="4111 1111 1111 1111"></div>
            <div class="field"><label>Vencimiento (MM/AA)</label><input placeholder="12/28"></div>
          </div>
          <div class="grid two" style="margin-top:8px">
            <div class="field"><label>Nombre en tarjeta</label><input placeholder="Nombre y apellido"></div>
            <div class="field" style="align-self:end">
              <button class="btn ok" id="debitPay">Pagar con link bancario</button>
            </div>
          </div>
          <div class="badge" id="bankLinkDebit">Link: ‚Äî</div>
        </div>

        <div id="pCredit" class="panel">
          <div class="grid two">
            <div class="field"><label>Tarjeta (simulado)</label><input placeholder="5555 5555 5555 4444"></div>
            <div class="field"><label>Cuotas</label><select><option>1 pago</option><option>3</option><option>6</option><option>12</option></select></div>
          </div>
          <div class="row" style="margin-top:8px;justify-content:space-between">
            <div class="badge" id="bankLinkCredit">Link: ‚Äî</div>
            <button class="btn ok" id="creditPay">Pagar con link bancario</button>
          </div>
        </div>

        <div id="shopMsg" class="badge" style="margin-top:12px">Eleg√≠ m√©todo y toc√° para desplegar.</div>

        <!-- Resultado -->
        <div id="shopQR" class="hidden" style="margin-top:14px">
          <div class="grid two">
            <div class="qrbox"><div id="shopQrCanvas"></div></div>
            <div class="grid">
              <strong id="shopQrName" style="font-size:1.1rem"></strong>
              <div>Evento: <span id="shopQrEvent"></span></div>
              <div>Token: <span id="shopQrToken"></span></div>
              <div class="row">
                <button class="btn primary" id="shopDlQR">Descargar QR</button>
                <button class="btn" id="shopCopy">Copiar link</button>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- ENTRADAS / Editor -->
  <section id="view-entries" class="section">
    <div class="card">
      <div class="card-h"><strong>Editor de invitaci√≥n</strong><span class="badge">Se guarda por evento</span></div>
      <div class="card-c">
        <div class="grid two">
          <div class="field"><label>Evento</label><select id="edEvent"></select></div>
          <div class="row" style="align-items:end">
            <button class="btn primary" id="edSave">Guardar dise√±o</button>
          </div>
        </div>

        <div class="grid two" style="margin-top:10px">
          <div class="qrbox"><canvas id="edCanvas" width="1200" height="675" style="width:100%;max-width:720px;border-radius:14px"></canvas></div>
          <div class="grid">
            <div class="field"><label>Tema</label>
              <select id="edTheme"><option value="noche">Noche</option><option value="oro">Oro</option><option value="plata">Plata</option><option value="custom">Personalizado</option></select>
            </div>
            <div class="grid two">
              <div class="field"><label>Fondo</label><input type="color" id="edBg" value="#000000"></div>
              <div class="field"><label>Texto</label><input type="color" id="edTx" value="#ffffff"></div>
            </div>
            <div class="grid two">
              <div class="field"><label>Logo del evento</label><input id="edLogo" type="file" accept="image/*"></div>
              <div class="field"><label>Logo escala (10‚Äì300%)</label><input id="edScale" type="range" min="10" max="300" value="160"></div>
            </div>
            <div class="grid two">
              <div class="field"><label>Logo X</label><input id="edX" type="range" min="0" max="1200" value="60"></div>
              <div class="field"><label>Logo Y</label><input id="edY" type="range" min="0" max="675" value="560"></div>
            </div>
            <div class="grid two">
              <div class="field"><label>Encabezado px</label><input id="fHead" type="range" min="20" max="80" value="46"></div>
              <div class="field"><label>T√≠tulo evento px</label><input id="fEvent" type="range" min="36" max="120" value="72"></div>
            </div>
            <div class="grid two">
              <div class="field"><label>Nombre invitado px</label><input id="fGuest" type="range" min="24" max="80" value="40"></div>
              <div class="field"><label>Token px</label><input id="fToken" type="range" min="20" max="64" value="34"></div>
            </div>
            <div class="field"><label>Nota px</label><input id="fNote" type="range" min="16" max="40" value="26"></div>

            <div class="badge">Ejemplo: ‚ÄúJuan P√©rez‚Äù ‚Äì solo para dimensionar (el cliente ver√° su nombre real).</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ESCANEAR -->
  <section id="view-scan" class="section">
    <div class="card">
      <div class="card-h"><strong>Escanear QR</strong></div>
      <div class="card-c">
        <div class="row">
          <div class="field" style="flex:1 1 260px"><label>Limitar al evento</label><select id="scanEvent"></select></div>
          <div class="field" style="width:210px"><label>&nbsp;</label><button class="btn primary" id="scanBtn">Iniciar c√°mara</button></div>
        </div>
        <div style="margin-top:10px"><video id="video" playsinline autoplay muted></video></div>
        <div id="scanMsg" class="badge" style="margin-top:10px">Esperando‚Ä¶</div>
      </div>
    </div>
  </section>

  <!-- CREAR EVENTO -->
  <section id="view-event" class="section">
    <div class="card">
      <div class="card-h"><strong>Crear evento</strong><span class="badge">Incluye alias/cvu y link bancario</span></div>
      <div class="card-c">
        <div class="grid three">
          <div class="field"><label>Nombre</label><input id="evName" placeholder="Noche Meseta"></div>
          <div class="field"><label>Fecha</label><input id="evDate" type="date"></div>
          <div class="field"><label>Precio (ARS)</label><input id="evPrice" type="number" min="0" step="1"></div>
        </div>
        <div class="grid two" style="margin-top:8px">
          <div class="field"><label>Alias / CBU / CVU (billetera)</label><input id="evAlias" placeholder="mi.alias.mp / 000..."></div>
          <div class="field"><label>Titular billetera</label><input id="evHolder" placeholder="Nombre del titular"></div>
        </div>
        <div class="field" style="margin-top:8px"><label>Link bancario para tarjetas (d√©bito/cr√©dito)</label><input id="evBank" placeholder="https://..."></div>
        <div class="row" style="margin-top:8px"><button class="btn primary" id="evCreate">Crear</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="card-h"><strong>Eventos</strong></div>
      <div class="card-c" id="evList"></div>
    </div>
  </section>

  <!-- AJUSTES -->
  <section id="view-settings" class="section">
    <div class="card">
      <div class="card-h"><strong>Ajustes y usuarios (demo)</strong></div>
      <div class="card-c">
        <div class="badge" id="ownerBadge">Due√±o: ‚Äî</div>
        <h4 style="margin:10px 0 4px">Crear usuario con permisos</h4>
        <div class="grid three">
          <div class="field"><label>Correo</label><input id="uEmail" placeholder="user@mail.com"></div>
          <div class="field"><label>Contrase√±a</label><input id="uPass" type="password" placeholder="******"></div>
          <div class="field" style="display:grid;align-content:end"><button class="btn ok" id="uCreate">Crear</button></div>
        </div>
        <div class="row" style="margin-top:8px;gap:18px">
          <label><input type="checkbox" id="pMenu" checked> Acceso bola disco (men√∫)</label>
          <label><input type="checkbox" id="pEntries" checked> Entradas</label>
          <label><input type="checkbox" id="pScan" checked> Escanear</label>
          <label><input type="checkbox" id="pEvent" checked> Crear evento</label>
        </div>
        <div style="margin-top:10px" id="uList"></div>
      </div>
    </div>
  </section>

</main>

<!-- MODAL: √∫nica registraci√≥n de due√±o + login -->
<div id="firstModal" class="modal">
  <div class="modal-body">
    <div class="modal-h"><strong id="firstTitle">Crear due√±o</strong><button class="btn" id="firstClose">Cerrar</button></div>
    <div class="modal-c">
      <div class="grid two">
        <div class="field"><label>Correo</label><input id="firstEmail" placeholder="tu@mail.com"></div>
        <div class="field"><label>Contrase√±a</label><input id="firstPass" type="password" placeholder="******"></div>
      </div>
      <div class="row" style="margin-top:10px"><button class="btn ok" id="firstCreate">Confirmar</button><div class="badge" id="firstMsg"></div></div>
    </div>
  </div>
</div>

<script>
/* ===== util ===== */
const $=id=>document.getElementById(id);
function toast(m){const t=document.createElement('div');t.className='toast';t.textContent=m;document.body.appendChild(t);setTimeout(()=>t.remove(),2200);}
function token(){return Math.random().toString(36).slice(2,6).toUpperCase()+'-'+Date.now().toString(36).slice(-4).toUpperCase();}
function buildURL(u,g){const base=(location.origin&&location.origin!=='null')?(location.origin+location.pathname):(location.href.split('#')[0].split('?')[0]);return `${base}?u=${encodeURIComponent(u)}&g=${encodeURIComponent(g.id)}&t=${encodeURIComponent(g.token)}`;}
async function drawQR(wrap,text,size=260){const el=$(wrap); el.innerHTML=''; const c=document.createElement('canvas'); c.width=c.height=size; el.appendChild(c); await new Promise((res,rej)=>QRCode.toCanvas(c,String(text),{width:size,errorCorrectionLevel:'M',margin:2},(e)=>e?rej(e):res()));}

/* ===== estado demo ===== */
const state = JSON.parse(localStorage.getItem('meseta_demo')||'{}');
state.users = state.users||[]; // {email, pass, perms{menu,entries,scan,event}}
state.owner = state.owner||null; // {email}
state.current = state.current||null; // email
state.events = state.events||[];   // {id,nombre,fecha,price,payment{alias,holder,bank},design{...}}
save();

function save(){localStorage.setItem('meseta_demo',JSON.stringify(state));}

/* ===== due√±o inicial / login controlado por bot√≥n "Entrar" ===== */
function showFirst(asLogin=false){
  $('firstTitle').textContent = (!state.owner && !asLogin) ? 'Crear due√±o' : 'Entrar';
  $('firstCreate').textContent = (!state.owner && !asLogin) ? 'Crear due√±o' : 'Entrar';
  $('firstEmail').value = state.owner?.email || '';
  $('firstPass').value = '';
  $('firstMsg').textContent='';
  $('firstModal').classList.add('show');
}
function hideFirst(){ $('firstModal').classList.remove('show'); }
$('firstClose').onclick=hideFirst;

$('loginBtn').onclick=()=>{
  // si no hay due√±o -> √∫nica registraci√≥n
  showFirst(!!state.owner);
};

$('firstCreate').onclick=()=>{
  const email=$('firstEmail').value.trim().toLowerCase();
  const pass=$('firstPass').value||'';
  if(!email||!pass){$('firstMsg').textContent='Complet√° ambos campos';return;}
  if(!state.owner){
    // crear √∫nico admin
    state.owner={email};
    state.users=[{email,pass,perms:{menu:true,entries:true,scan:true,event:true}}];
    state.current=email; save(); hydrateUI(); hideFirst(); toast('Due√±o creado ‚úîÔ∏è');
  }else{
    // login del due√±o (o de otro usuario creado en ajustes)
    const u=state.users.find(x=>x.email===email && x.pass===pass);
    if(u){ state.current=u.email; save(); hydrateUI(); hideFirst(); toast('Sesi√≥n iniciada'); }
    else{$('firstMsg').textContent='Credenciales inv√°lidas';}
  }
};

function hydrateUI(){
  $('ownerBadge').textContent='Due√±o: ' + (state.owner?state.owner.email:'‚Äî');
  $('userChip').textContent = state.current || 'Invitado';
  // mostrar/ocultar "Entrar"
  $('loginBtn').classList.toggle('hidden', !!state.current);
  renderUsers(); renderEvents(); fillCombos(); refreshDesignEditor();
}
function logout(){state.current=null; save(); hydrateUI();}

/* Chip (correo) -> cerrar sesi√≥n */
$('userChip').onclick=()=>{
  if(!state.current) return;
  if(confirm('¬øCerrar sesi√≥n?')) logout();
};

/* ===== men√∫ bola disco con permisos ===== */
function currentUser(){ return state.users.find(u=>u.email===state.current)||null; }
$('discoBtn').onclick=(e)=>{
  const u=currentUser();
  if(!u || !u.perms?.menu){ toast('No ten√©s permiso para abrir el men√∫'); return; }
  $('sideMenu').classList.toggle('show');
};
$('sideMenu').addEventListener('click',(e)=>{
  const it=e.target.closest('.item'); if(!it) return;
  const go=it.dataset.go; show(go);
  $('sideMenu').classList.remove('show');
});
function show(view){
  const map={shop:'view-shop',entries:'view-entries',scan:'view-scan',event:'view-event',settings:'view-settings'};
  Object.values(map).forEach(id=>{ const el=$(id); el.classList.toggle('show', id===map[view]); el.style.display = id===map[view]?'block':'none'; });
}

/* ===== crear usuarios y permisos (demo) ===== */
$('uCreate').onclick=()=>{
  const email=$('uEmail').value.trim().toLowerCase(); const pass=$('uPass').value||'';
  if(!email||!pass) return toast('Complet√° correo y contrase√±a');
  if(state.users.some(u=>u.email===email)) return toast('Ya existe ese correo');
  state.users.push({email,pass,perms:{menu:$('pMenu').checked,entries:$('pEntries').checked,scan:$('pScan').checked,event:$('pEvent').checked}});
  save(); renderUsers(); toast('Usuario creado');
};
function renderUsers(){
  const box=$('uList'); box.innerHTML='';
  state.users.forEach(u=>{
    const div=document.createElement('div'); div.className='badge'; div.style.marginRight='6px';
    div.textContent = `${u.email} ¬∑ perms: ${Object.keys(u.perms).filter(k=>u.perms[k]).join(', ')||'‚Äî'}`;
    box.appendChild(div);
  });
}

/* ===== eventos ===== */
$('evCreate').onclick=()=>{
  const nombre=$('evName').value.trim(); const fecha=$('evDate').value||''; const price=parseInt($('evPrice').value||'0',10)||0;
  const alias=$('evAlias').value.trim(); const holder=$('evHolder').value.trim(); const bank=$('evBank').value.trim();
  if(!nombre) return toast('Nombre?');
  const id='ev_'+Math.random().toString(36).slice(2,8);
  state.events.push({id,nombre,fecha,price,payment:{alias,holder,bank},design:defaultDesign()});
  $('evName').value='';$('evDate').value='';$('evPrice').value='';$('evAlias').value='';$('evHolder').value='';$('evBank').value='';
  save(); renderEvents(); fillCombos(); refreshDesignEditor(); toast('Evento creado');
};
function renderEvents(){
  const cont=$('evList'); cont.innerHTML='';
  if(!state.events.length){ cont.innerHTML='<span class="badge">Sin eventos</span>'; return; }
  state.events.slice().reverse().forEach(ev=>{
    const row=document.createElement('div'); row.className='row'; row.style.cssText='justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--line)';
    row.innerHTML = `<div><strong>${ev.nombre}</strong> ¬∑ ${ev.fecha||'‚Äî'} ¬∑ <span class="badge">ARS ${ev.price}</span> ¬∑ <span class="badge">alias/cbu: ${(ev.payment?.alias||'‚Äî')}</span></div>
                     <button class="btn" data-del="${ev.id}">Eliminar</button>`;
    cont.appendChild(row);
  });
  cont.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>{ state.events=state.events.filter(e=>e.id!==b.dataset.del); save(); renderEvents(); fillCombos(); });
}
function fillCombos(){
  const opts=state.events.map(e=>`<option value="${e.id}">${e.nombre}</option>`).join('');
  $('shopEvent').innerHTML=`<option value="">Eleg√≠ evento‚Ä¶</option>${opts}`;
  $('edEvent').innerHTML=`<option value="">Eleg√≠ evento‚Ä¶</option>${opts}`;
  $('scanEvent').innerHTML=`<option value="">(Todos)</option>${opts}`;
  setShopPrice();
}
$('shopEvent').onchange=setShopPrice;
function setShopPrice(){
  const ev=state.events.find(e=>e.id===$('shopEvent').value);
  $('shopPrice').textContent = ev?`Precio: ARS ${ev.price}`:'Precio: ‚Äî';
  // hidratar paneles con datos del evento
  $('walletAlias').value=ev?.payment?.alias||''; $('walletHolder').value=ev?.payment?.holder||'';
  $('bankLinkDebit').textContent = 'Link: ' + (ev?.payment?.bank||'‚Äî');
  $('bankLinkCredit').textContent = 'Link: ' + (ev?.payment?.bank||'‚Äî');
}

/* ===== m√©todos de pago => paneles ===== */
function togglePanel(id){ ['pWallet','pDebit','pCredit'].forEach(x=>$(x).classList.toggle('show',x===id)); }
$('mWallet').onclick=()=>togglePanel('pWallet');
$('mDebit').onclick=()=>togglePanel('pDebit');
$('mCredit').onclick=()=>togglePanel('pCredit');

$('walletConfirm').onclick=() => emitirQR('wallet');
$('debitPay').onclick   =() => emitirQR('debit');
$('creditPay').onclick  =() => emitirQR('credit');

async function emitirQR(source){
  const evId=$('shopEvent').value; const name=($('shopName').value||'').trim();
  if(!evId) return toast('Eleg√≠ evento'); if(!name) return toast('Pon√© tu nombre');
  const ev=state.events.find(e=>e.id===evId); if(!ev) return;
  if((source==='debit'||source==='credit') && !ev.payment?.bank) return toast('El evento no tiene link bancario');
  // emite (demo)
  const gid='g_'+Math.random().toString(36).slice(2,8); const tok=token();
  const url=buildURL(state.owner?.email||'owner', {id:gid, token:tok});
  await drawQR('shopQrCanvas', url, 260);
  $('shopQrName').textContent=name; $('shopQrEvent').textContent=ev.nombre; $('shopQrToken').textContent=tok;
  $('shopQR').classList.remove('hidden');
  $('shopMsg').textContent='¬°Gracias por su compra! La invitaci√≥n se enviar√° al verificar el pago.';
  $('shopDlQR').onclick=()=>{const c=document.querySelector('#shopQrCanvas canvas'); const a=document.createElement('a'); a.download=`QR_${name.replace(/\s+/g,'_')}.png`; a.href=c.toDataURL('image/png'); a.click();}
  $('shopCopy').onclick=async()=>{try{await navigator.clipboard.writeText(url);toast('Enlace copiado');}catch{toast('No se pudo copiar');}}
}

/* ===== Esc√°ner (demo formato) ===== */
let stream=null, zxing=null, raf=null, detector=null, busy=false,last='';
$('scanBtn').onclick=async()=>{
  if(stream){ stopScan(); $('scanBtn').textContent='Iniciar c√°mara'; return; }
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'},width:{ideal:1280},height:{ideal:720}},audio:false});
    const v=$('video'); v.srcObject=stream; await v.play(); $('scanMsg').textContent='Escaneando‚Ä¶';
    if('BarcodeDetector'in window){
      detector=new BarcodeDetector({formats:['qr_code']}); const cvs=document.createElement('canvas'); const ctx=cvs.getContext('2d');
      const loop=async()=>{ if(!stream) return; cvs.width=v.videoWidth||640;cvs.height=v.videoHeight||480;ctx.drawImage(v,0,0,cvs.width,cvs.height); const codes=await detector.detect(cvs); if(codes?.length){ await onDecoded(codes[0].rawValue);} raf=requestAnimationFrame(loop);}; loop();
    }
    zxing=new ZXing.BrowserMultiFormatReader(); zxing.decodeFromVideoElementContinuously(v, async (r,err)=>{ if(r?.getText){ await onDecoded(r.getText()); } });
    $('scanBtn').textContent='Detener c√°mara';
  }catch(e){console.error(e);$('scanMsg').textContent='No se pudo abrir la c√°mara';}
};
function stopScan(){ if(raf)cancelAnimationFrame(raf); if(zxing){try{zxing.reset();}catch{}} if(stream){stream.getTracks().forEach(t=>t.stop());} stream=null; $('video').srcObject=null; busy=false; last=''; $('scanMsg').textContent='C√°mara detenida'; }
async function onDecoded(txt){ if(busy||!txt||txt===last) return; busy=true; last=txt; try{ const u=new URL(txt); const ok=u.searchParams.get('u')&&u.searchParams.get('g')&&u.searchParams.get('t'); $('scanMsg').textContent= ok?'‚úÖ QR v√°lido (demo)':'‚ùå Formato no v√°lido'; }catch{ $('scanMsg').textContent='‚ùå QR inv√°lido'; } finally{ setTimeout(()=>busy=false,900); } }

/* ===== Editor (mismo formato que tu flyer) ===== */
function defaultDesign(){return {theme:'noche',bg:'#000000',tx:'#ffffff',logo:null,logoCfg:{x:60,y:560,scale:160},fonts:{head:46,event:72,guest:40,token:34,note:26}};}
const sample={guest:'Juan P√©rez', token:'ABCD-1F2G'};
['edEvent','edTheme','edBg','edTx','edLogo','edScale','edX','edY','fHead','fEvent','fGuest','fToken','fNote'].forEach(id=>{
  const el=$(id); el.oninput=()=>{applyControlsToDesign(); paintDesign();};
});
$('edSave').onclick=()=>{ const ev = currentEditEvent(); if(!ev) return toast('Eleg√≠ evento'); ev.design = getControlsDesign(); save(); toast('Dise√±o guardado'); };

function currentEditEvent(){ const id=$('edEvent').value; return state.events.find(e=>e.id===id); }
function refreshDesignEditor(){
  const ev=currentEditEvent(); if(!ev){ paintDesign(true); return; }
  const d=ev.design||defaultDesign();
  $('edTheme').value=d.theme; $('edBg').value=d.bg; $('edTx').value=d.tx;
  $('edScale').value=d.logoCfg.scale; $('edX').value=d.logoCfg.x; $('edY').value=d.logoCfg.y;
  $('fHead').value=d.fonts.head; $('fEvent').value=d.fonts.event; $('fGuest').value=d.fonts.guest; $('fToken').value=d.fonts.token; $('fNote').value=d.fonts.note;
  paintDesign();
}
$('edEvent').onchange=()=>refreshDesignEditor();
$('edLogo').onchange=(e)=>{
  const f=e.target.files?.[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ const ev=currentEditEvent(); if(!ev) return; ev.design = ev.design||defaultDesign(); ev.design.logo=r.result; save(); paintDesign(); toast('Logo cargado'); }; r.readAsDataURL(f);
};
function getControlsDesign(){
  const ev=currentEditEvent(); const base=ev?.design||defaultDesign();
  return {
    theme:$('edTheme').value, bg:$('edBg').value, tx:$('edTx').value, logo:base.logo,
    logoCfg:{x:parseInt($('edX').value,10), y:parseInt($('edY').value,10), scale:parseInt($('edScale').value,10)},
    fonts:{head:parseInt($('fHead').value,10), event:parseInt($('fEvent').value,10), guest:parseInt($('fGuest').value,10), token:parseInt($('fToken').value,10), note:parseInt($('fNote').value,10)}
  };
}
function applyControlsToDesign(){ const ev=currentEditEvent(); if(!ev) return; ev.design = getControlsDesign(); save(); }
async function paintDesign(blank){
  const c=$('edCanvas'), ctx=c.getContext('2d'); ctx.clearRect(0,0,c.width,c.height);
  const ev=currentEditEvent(); const d=ev?.design||defaultDesign();
  // fondo / temas
  if(d.theme==='oro'){const g=ctx.createLinearGradient(0,0,0,c.height); g.addColorStop(0,'#fff7d1');g.addColorStop(.55,'#f5d777');g.addColorStop(1,'#d4af37'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(0,0,0,.08)'; for(let i=0;i<18;i++) ctx.fillRect(70*i,0,1,c.height);
  }else if(d.theme==='plata'){const g=ctx.createLinearGradient(0,0,c.width,0); g.addColorStop(0,'#f5f7fa');g.addColorStop(1,'#cfd8dc'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(0,0,0,.06)'; for(let i=0;i<14;i++) ctx.fillRect(0,48*i,c.width,1);
  }else if(d.theme==='noche'){const g=ctx.createLinearGradient(0,0,0,c.height); g.addColorStop(0,'#0b1020');g.addColorStop(1,'#1f2937'); ctx.fillStyle=g; ctx.fillRect(0,0,c.width,c.height); ctx.fillStyle='rgba(255,255,255,.06)'; for(let i=0;i<14;i++) ctx.fillRect(0,48*i,c.width,1);
  }else{ ctx.fillStyle=d.bg||'#000'; ctx.fillRect(0,0,c.width,c.height); }
  ctx.fillStyle = d.tx||'#fff';

  const F=d.fonts;
  ctx.font=`800 ${F.head}px "Poppins",sans-serif`; ctx.fillText('EST√ÅS INVITADO/A A',60,80+F.head);
  ctx.font=`900 ${F.event}px "Poppins",sans-serif`; wrap(ctx, ev?ev.nombre:'Evento Meseta', 60, 150+F.head, 680, F.event);
  ctx.font=`700 ${F.guest}px "Poppins",sans-serif`; wrap(ctx, `Invitado/a: Juan P√©rez`, 60, 170+F.head+F.event, 680, F.guest);
  ctx.font=`600 ${F.token}px "Poppins",sans-serif`; ctx.fillText(`Token: ABCD-1F2G`, 60, 200+F.head+F.event+F.guest);
  ctx.font=`500 ${F.note}px "Poppins",sans-serif`; ctx.fillText('Present√° este flyer al ingresar. El QR o el token son de uso √∫nico.',60,230+F.head+F.event+F.guest);

  // QR ejemplo
  const qrUrl = buildURL('owner',{id:'g_demo',token:'ABCD-1F2G'});
  const qrC=document.createElement('canvas'); await new Promise((res,rej)=>QRCode.toCanvas(qrC,qrUrl,{width:260,margin:2,errorCorrectionLevel:'M'},(e)=>e?rej(e):res()));
  const qrX=c.width-60-260, qrY=60; ctx.save(); ctx.shadowColor='rgba(0,0,0,.18)'; ctx.shadowBlur=12; ctx.fillStyle='#fff';
  roundRect(ctx,qrX-10,qrY-10,280,280,16); ctx.fill(); ctx.restore(); ctx.drawImage(qrC,qrX,qrY,260,260);

  // Logo
  if(d.logo){ try{const img=new Image(); img.onload=()=>{const baseW=360,scale=(d.logoCfg.scale||160)/100; const w=Math.max(40,Math.round(baseW*scale)); const ratio=img.naturalWidth/img.naturalHeight; const h=Math.round(w/ratio); const x=Math.min(Math.max(0,d.logoCfg.x||60),1200-w); const y=Math.min(Math.max(0,d.logoCfg.y||560),675-h); ctx.drawImage(img,x,y,w,h);}; img.src=d.logo;}catch(_){}
}
function wrap(ctx,text,x,y,maxW,lh){const words=String(text||'').split(' '); let line='',yy=y; for(let n=0;n<words.length;n++){const test=line+words[n]+' '; if(ctx.measureText(test).width>maxW&&n>0){ctx.fillText(line,x,yy); line=words[n]+' '; yy+=lh+12;} else line=test;} ctx.fillText(line,x,yy);}
function roundRect(ctx,x,y,w,h,r){const rr=Math.min(r,w/2,h/2); ctx.beginPath(); ctx.moveTo(x+rr,y); ctx.arcTo(x+w,y,x+w,y+h,rr); ctx.arcTo(x+w,y+h,x,y+h,rr); ctx.arcTo(x,y+h,x,y,rr); ctx.arcTo(x,y,x+w,y,rr); ctx.closePath();}

/* ===== navegaci√≥n r√°pida desde men√∫ ===== */
function go(view){ show(view); }

/* ===== init ===== */
window.addEventListener('load',()=>{
  hydrateUI();
  // demo: si no hay due√±o, sugerir usar "Entrar" para crear admin
  if(!state.owner){ toast('Toca ‚ÄúEntrar‚Äù para crear tu usuario admin (una sola vez)'); }
});
</script>
</body>
</html>
